# TCP三次握手与四次挥手

## 一、三次握手

<img src="https://raw.githubusercontent.com/KKKLxxx/img-host/master/GSygpdRW2KO4Xl6.jpg" style="zoom:80%;" />

### 3次挥手的过程如下

1、client向server请求连接（SYN）

2、server同意client的连接（SYN+ACK）

3、client向server确认连接（ACK）

SYN相当于一个申请建立连接的信号，ACK相当于一个确认建立连接的信号

### 不能只进行2次握手的原因

防止已失效的连接请求突然又传送到了服务端，因而产生错误导致重复建立连接

“已失效的连接请求报文段”的产生在这样一种情况下：client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间地滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。假设不采用“三次握手”，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。采用“三次握手”的办法可以防止上述现象发生

### SYN攻击

SYN攻击是客户端通过伪造IP地址，向服务器发送大量的syn包，使得服务器回应后，一直无法得到客户端的第3次握手回应，导致服务器一直重试并保留大量不正常的连接，耗费服务器资源

## 二、四次挥手

<img src="https://raw.githubusercontent.com/KKKLxxx/img-host/master/xfYn7Jh68C2uIjM.jpg" style="zoom:80%;" />

### 4次挥手的过程如下

1、主机A向主机B申请断开连接（FIN）

2、主机B同意主机A的断开连接请求（ACK）

3、主机B向主机A申请断开连接（FIN）

4、主机A确认断开连接（ACK），发送完后主机A进入TIME_WAIT状态，等待2MSL（报文最大生存时间）

### 为什么主机B的ACK和FIN要分两次传输

因为主机B回传ACK只表示主机B同意断开连接，但并不等于现在就可以断开连接，因为主机B可能还有未发送完的消息，等主机B发送完了所有消息，才能够传FIN

### 为什么TIME_WAIT状态必须等待2MSL（不能只进行3次挥手的原因）

1、保证主机A发送的最后一个ACK报文能够到达主机B。如果A在TIME-WAIT状态不等待一段时间并且ACK丢失，就无法收到B重传的FIN，因而也不会再发送一次ACK。这样，B就无法按照正常的步骤进入CLOSED状态

2、使本次连接所产生的所有报文段都从网络中消失，这样就可以使下一个新的连接中不会出现旧的连接请求的报文段 

### 有大量处于TIME_WAIT状态的连接如何处理

可以设置MSL参数以减少等待时间

