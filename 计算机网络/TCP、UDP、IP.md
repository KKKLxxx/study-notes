# TCP、UDP、IP

## 一、TCP与UDP对比

|                  | TCP                | UDP                                       |
| ---------------- | ------------------ | ----------------------------------------- |
| **是否面向连接** | 面向连接           | 无连接                                    |
| **可靠性**       | 可靠               | 不可靠                                    |
| **传输形式**     | 字节流（导致粘包） | 报文                                      |
| **传输速度**     | 慢                 | 快                                        |
| **所需资源**     | 多                 | 少                                        |
| **应用场景**     | 可靠性要求大于时延 | 时延要求大于可靠性，如直播、语音、**DNS** |

## 二、TCP如何保证传输可靠

**校验和**

**序号、确认应答**：ACK

**超时重传**：重传计时器

**连接管理**：连接需要3次握手

**流量控制**：主要考虑的是端之间的发送、接收处理能力。滑动窗口，Nagle算法避免发送方发送小包，Clark算法避免接收方发送只有一个字节的窗口更新段

**拥塞控制**：主要考虑网络传输能力。慢启动+AIMD（加性增，乘性减），维护拥塞窗口

## 三、如何实现UDP可靠传输

在应用层实现校验、确认、重发、拥塞控制、流量控制等功能

## 四、TCP报文结构

### （1）TCP报文格式图示

![](https://raw.githubusercontent.com/KKKLxxx/img-host/master/9sfJzAGElKHe5ai.jpg)

### （2）固定头部各字段解释

**【源端口】- 16bit**

　　来源处的端口号；端口号有65536个

**【目的端口】- 16bit**

​		目的处的端口号

**【序号】- 32bit**

　　TCP是面向连接的可靠服务，这个序号可以保证数据在传输过程中保持有序性，接受端可以通过这个序号确认收到的数据的完整性和先后顺序

**【确认号】- 32bit**

　　确认号，是期望收到对方的下一个报文段的数据的第一个字节的序号

**【数据偏移】- 4bit**

　　指TCP报文段的数据部分的起始处距离TCP报文段的起始处的距离

**【保留字段】- 6bit**

　　IETF文档指出，这6bit在标准中是保留字段，留待以后使用，必须为0。我猜测，有两个目的，第一个是预留除URG/ACK/PSH/RST/SYN/FIN之外的冗余功能位；第二个是为了对齐字节位。

**【控制位】- 6bit**

　　**① 紧急字段URG - 1bit**

　　　　当URG=1时，此字段告诉系统此报文段中有紧急数据，应尽快传送

　　**② 确认字段ACK - 1bit**

　　　　当ACK=1时，表示确认，且确认号有效；当ACK=0时，确认号字段无效

　　**③ 推送字段PSH - 1bit**

　　　　当PSH=1时，则报文段会被尽快地交付给目的方，不会对这样的报文段使用缓存策略

　　**④ 复位字段RST - 1bit**

　　　　当RST为1时，表明TCP连接中出现了严重的差错，必须释放连接，然后再重新建立连接

　　**⑤ 同步字段SYN - 1bit**

　　　　当SYN=1时，表示发起一个连接请求

　　**⑥ 终止字段FIN - 1bit**

　　　　用来释放连接。当FIN=1时，表明此报文段的发送端的数据已发送完成，并要求释放连接

**【窗口字段】- 16bit**

　　此字段用来控制对方发送的数据量，单位为字节

**【校验和字段】- 16bit**

　　与IP协议的检验和不同，TCP的这个校验和是针对首部和数据两部分的

**【紧急指针字段】- 16bit**

　　紧急指针指出在本报文段中的紧急数据的最后一个字节的序号

### （3）可选头部各字段解释

　　在TCP报文头部的前20个字节是固定的。有时TCP报文也会在报文头部增加一些选项，该部分的长度不固定，不同的应用场景会有所变化。

　　该部分的可选项常用的包含但不仅限于有以下几种：

　　① 最大报文传输段（即常提到的MSS）: 用于确定每一个TCP报文段中科传输的最大的数据长度（注意，不包括头部）

　　② 窗口扩大选项：TCP的窗口大小最大为64K，在大多数时候这是够用的，但有时候为了提高吞吐量，就需要对窗口扩大，这个时候，就需要使用该选项对窗口进行扩大。

　　③ 时间戳选项:可以用来计算RLL，进而可以用于TCP的拥塞控制。

### （4）一个TCP包中数据最长为多少

数据长度受到两方面限制，**MTU**长度与**TCP报文头部**长度。

MTU（Maximum Transmission Unit，最大传输单元）一般为1500字节，过长的话数据发送间隔过长，过短的话传输效率低

TCP报文头部长度在20-60字节之间，20字节之后为可选字段

所以一个TCP包中数据部分长度最长为**1480字节**

## 五、UDP报文结构

每个 UDP 报文分为 UDP 报头和 UDP 数据区两部分。报头由 4 个 16 位长（**2 字节**）字段组成，分别说明该报文的源端口、目的端口、报文长度和校验值。

### （1）UDP报文格式图示

![](https://raw.githubusercontent.com/KKKLxxx/img-host/master/nq2FGTjKoIvAwb5.gif)

### （2）固定头部的各字段解释

- 源端口
- 目的端口
- 长度：该字段占据 16 位，表示 UDP 数据报长度，包含 UDP 报文头和 UDP 数据长度。因为 UDP 报文头长度是 8 个字节，所以这个值最小为 8
- 校验值：该字段占据 16 位，可以检验数据在传输过程中是否被损坏

## 六、IP报文结构

### （1）IP报文格式图示

<img src="https://raw.githubusercontent.com/KKKLxxx/img-host/master/TrxYELhGgjkVze9.png" alt="在这里插入图片描述" style="zoom: 80%;" />

TCP与UDP报文包含着IP报文

### （2）固定头部的各字段解释

版本：ipv4/ipv6

