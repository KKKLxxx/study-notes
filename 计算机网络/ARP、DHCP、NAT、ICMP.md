# ARP、DHCP、NAT、ICMP

## 1. ARP

### 1.1 作用

将 **IP地址** 解析为 **MAC地址（物理地址）**，以便在局域网内传输数据帧

### 1.2 工作流程

1、检查ARP表，若不存在对应的记录，则进行如下操作，否则直接返回MAC地址

2、**广播请求**，询问某IP地址对应的MAC地址

3、局域网内各设备收到请求，但只有对应IP地址的设备会进行**单播响应**，告诉其自己的MAC地址

4、更新ARP表

### 1.3 为什么有了IP地址还需要MAC地址？

IP地址用于局域网间的寻址，MAC地址用于局域网内的寻址

若仅用IP地址，由于IPv4数量不够，无法给每个设备单独分配一个地址

若仅用MAC地址，由于MAC地址没有网络号/主机号的结构划分，所以无法用于局域网间的寻址，否则寻址性能很低

## 2. DHCP

### 2.1 作用

自动为网络中的设备分配IP地址、子网掩码、默认网关、DNS服务器等配置

### 2.2 工作流程

1、客户端加入网络时无IP配置，**广播发送DHCP发现报文**，询问DHCP服务器的IP

2、服务器**广播发送DHCP提供报文**（因为此时客户端仍无IP），提供一个可用的IP

3、客户端**广播发送DHCP请求报文**，表示接受该IP地址

4、服务器**广播发送ACK**，结束IP分配流程

## 3. NAT

### 3.1 作用

将私有IP地址转换为公有IP地址，解决IPv4地址短缺问题，同时隐藏内网结构

### 3.2 工作流程

通过NAT表记录内网IP/端口与公网IP/端口的对应关系，在经过NAT路由器时，会修改报文中的IP与端口，从而在局域网内外进行正确的路由

## 4. ICMP

### 4.1 作用

互联网控制报文协议，在IP网络中发送控制消息，用于网络诊断、错误报告和管理

### 4.2 主要消息类型

1、查询类：echo消息（ping）、时间戳

2、错误报告类：目标不可达、TTL超时（traceroute）

### 4.3 ping工作原理

使用echo消息测试可达性，并通过时间戳记录往返时延

ping并非基于UDP或TCP，而是基于ICMP

### 4.4 traceroute工作原理

用于追踪数据包从源主机到目标主机所经过的路由路径

利用TTL超时消息，设置TTL初始为1，使得报文经过第一个路由器时就会返回超时报文，从而获取该路由器的IP地址。逐步增加报文中的TTL，就可以得到路径上所有的路由器，直到达到目的主机