# MySQL两阶段提交

## 一、两阶段提交是什么

两阶段提交指的是为了保证事务的持久性，redo log会进行两阶段提交

## 二、两阶段提交的必要性

要考虑两阶段提交的必要性，可以从以下几个问题入手

### 1、为什么不能用bin log保证持久性

因为bin log是一种全量日志，无法判断其中哪些数据已经保存在数据库中而哪些没有

而redo log中保存的只有未写入磁盘的事务，所以redo log中存在的内容都是需要恢复的内容

### 2、为什么不能直接写数据库而要先写redo log

首先一定要写bin log，不然无法进行主从复制

如果只是先写bin log再写数据库。正如上面所说，bin log不能用于数据恢复

### 3、先写redo log再写bin log再写数据库有什么问题

如果在写完redo log之后宕机，服务重启后，虽然主库中能够根据redo log恢复数据，但是bin log中不存在日志，就会导致主从复制的时候，从库中没有相应的数据

### 4、先写bin log再写redo log再写数据库有什么问题

如果在写完bin log之后宕机，服务重启后，从库可以根据bin log同步数据，但是主库并不会恢复数据

## 三、两阶段提交过程

1、数据库在内存中进行数据的修改

（记录undo log）

2、记录redo log，但此时redo log处于prepare状态

3、bin log写入磁盘

4、提交事务，将数据写入磁盘

5、redo log改为commit状态

如果数据库在步骤3完成之前宕机，那么就会回滚事务

如果数据库在步骤3完成之后宕机，就会进行数据恢复，并且不会出现主从库数据不一致的问题