# MySQL两阶段提交

两阶段提交（Two-Phase Commit, **2PC**）是 MySQL 中为了保证 **Redo Log** 和 **Binlog** 之间的数据一致性而设计的一种内部协调机制。

## 一、 为什么需要两阶段提交？（作用）

在 MySQL 执行更新语句时，会同时产生 Redo Log 和 Binlog 。

如果不使用两阶段提交，无论先写哪一个日志，只要在两个日志写入的中间时刻发生宕机，就会导致主从不一致。

- **先写 Redo 后写 Binlog**：主库数据恢复了，但从库没同步到，主从不一致。
- **先写 Binlog 后写 Redo**：从库同步了，但主库宕机重启后数据丢失，主从不一致。

## 二、 两阶段提交的过程

为了解决上述问题，MySQL 将 Redo Log 的写入拆分成了两个步骤：**Prepare** 和 **Commit**。

### 1. Prepare 阶段（准备阶段）

生成Redo Log后，将其状态设置为prepare，并写入磁盘

### 2. 写 Binlog 阶段

生成Binlog后，直接写入磁盘

### 3. Commit 阶段（提交阶段）

事务提交时，将 Redo Log 的状态改为 **commit**，之后完成事务的提交

## 三、 异常情况下的恢复逻辑（核心）

如果在两阶段提交的过程中，数据库突然宕机，重启后 MySQL 会如何处理？

MySQL 会根据 Redo Log 和 Binlog 的状态进行判断：

- **情况 A：Redo Log 在 prepare 时就写入失败**
  - **处理**：回滚事务。如果在 Prepare 阶段写入 Redo Log 就失败了，事务会直接报错回滚，不会进入后续流程，因此不会产生一致性问题。
- **情况 B：Redo Log 处于 prepare 状态，但 Binlog 中没有记录**
  - **处理**：回滚事务。说明 Binlog 还没写完就宕机了，如果不回滚，主库有数据而从库没有，会导致不一致。
- **情况 C：Redo Log 处于 prepare 状态，且 Binlog 中有记录**
  - **处理**：提交事务。虽然 Redo Log 还没来得及改状态，但既然 Binlog 已经落盘，说明从库会执行该操作，主库也必须提交以保持一致。
- **情况 D：Redo Log 处于 commit 状态**
  - **处理**：直接提交事务。说明 Binlog 已经写完了，数据是安全的。

## 四、 常见问题

### 1. 为什么是将redo log两阶段提交，而不是将binlog两阶段提交？

因为崩溃恢复时，系统首先看的是 Redo Log（物理页状态）。如果 Redo Log 已经写入，物理修改就不可逆了，Binlog 的状态再多也无法约束物理层的恢复。

### 2. 两阶段提交的性能瓶颈在哪里？

两阶段提交涉及多次**磁盘 fsync** 操作（Redo Log 一次，Binlog 一次）。在高并发场景下，磁盘 I/O 会成为瓶颈。

- **解决方案**：MySQL 引入了 **组提交（Group Commit）** 技术。它将多个并发事务的 Binlog 刷盘动作合并为一次，从而大幅提升吞吐量。