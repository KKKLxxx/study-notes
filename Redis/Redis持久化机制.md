# Redis持久化机制

## 一、RDB（Redis DataBase）

### 1. 简述

定期生成数据快照，并替换旧文件

RDB有`save`和`bgsave`两种方式（指令）：

- **save**：由主进程执行，执行时会阻塞所有命令
- **bgsave**：由主进程fork()出子进程执行，避免对主进程的影响，此时主进程和子进程可以同时访问相同的物理内存。如果此时发生了写操作，主进程会通过`copy-on-write`技术（只有在发生修改内存数据的情况时，物理内存才会被复制一份），将对应的key生成副本，并交给子进程写入RDB文件，而主进程仍然对原来的物理内存进行操作

### 2. 优缺点

- **优点**
  - 快照消耗空间小
  - 恢复速度快

- **缺点**
  - 有可能在临近生成快照前宕机，导致丢失大量数据

## 二、AOF（Append Only File）

### 1. 简述

以日志形式记录写操作，恢复数据时就是重新执行文件中的命令

Redis 是先执行写操作命令后，才将该命令记录到 AOF 日志里的。这种形式避免阻塞了当前命令，但如果在记录日之前发生宕机可能造成数据丢失

日志记录的时机有3种：

- **Always**：每次执行命令后就记录
- **Everysec**：每秒记录一次
- **No**：由操作系统控制写入时机

每种策略都有性能和完整性的不同，Everysec是一种折中的选择

### 2. AOF重写机制

当AOF文件过大时，需要对其重写瘦身

具体方式为，读取日志中key的最新value，生成一条写命令保存到一个新的AOF文件中，并舍弃之前的操作记录。当所有key重写完成后，用新文件替换旧文件

需要通过一个名为`bgrewriteaof`的子进程实现日志重写，防止避免阻塞主进程

### 3. 优缺点

- **优点**
  - 数据损失率更小
- **缺点**
  - 空间消耗大于RDB，需要定期对文件进行瘦身
  - 由于要重复执行所有命令，所以数据恢复速度较慢

## 三、混合持久化

混合持久化是在 **AOF 重写时**，将当前内存快照以 RDB 格式写入新 AOF 文件开头，后续再追加增量 AOF 命令，最后覆盖旧 AOF 文件

也就是说，使用了混合持久化，AOF 文件的前半部分是 RDB 格式的全量数据，后半部分是 AOF 格式的增量数据

这样兼顾了数据恢复的速度和数据的完整性

Q：混合持久化平时写数据时会用到 RDB 吗？

A：不会，只在 AOF 重写阶段使用 RDB

