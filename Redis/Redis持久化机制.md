# Redis持久化机制

## 一、RDB（Redis DataBase）

### 1、简述

定期生成数据快照，并替换旧文件

RDB有`save`和`bgsave`两种方式（指令）：

- save：由主进程执行，执行时会阻塞所有命令
- bgsave：由主进程fork()出子进程执行，避免对主进程的影响，此时主进程和子进程可以同时访问相同的物理内存。如果此时发生了写操作，主进程会通过`copy-on-write`技术，将对应的key生成副本，并交给子进程写入rdb文件，而主进程仍然对原来的物理内存进行操作

### 2、优点

1、快照消耗空间小

2、恢复速度快

### 3、缺点

有可能在临近生成快照前宕机，导致丢失大量数据

## 二、AOF（Append Only File）

### 1、简述

以日志形式记录写操作

### 2、优点

数据损失率更小

### 3、缺点

1、空间消耗大于RDB，需要定期对文件进行瘦身，可以通过`bgrewriteaof`命令简化日志

2、由于要重复执行所有命令，所以数据恢复速度较慢

## 三、选择

默认的持久化机制是RDB，如果对数据完整性要求高可以使用AOF

两种方式可以同时开启，但会优先通过AOF方式恢复数据，因为AOF的数据完整性更高

如果考虑Redis集群，可以考虑主从使用不同持久化机制。比如主用AOF尽量保证数据完整性，从用RDB实现快速恢复