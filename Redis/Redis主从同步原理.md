# Redis主从同步原理

## 一、全量同步

当两台Redis实例刚建立主从关系时，需要首先进行一次全量同步。对于是否是第一次请求同步的判断，是通过`Replication ID`实现的

`Replication ID`是数据集的ID，简称`replid`，ID一致表明是同一数据集。所以在主从关系中，所有Redis实例应有相同的`replid`

`repl_backlog`用于记录根据RDB进行全量同步期间执行的新命令，是一种纯内存的缓冲区，主从会可根据各自的`offset`判断是否完全同步

全量同步前，还要先建立主从关系，这是通过`replicaof`命令实现的。从服务器需要执行`replicaof`命令与主服务器建立连接，使用方法如下：

```
replicaof <主服务器的 IP 地址> <主服务器的 Redis 端口号>
```

全量同步过程可以分为三个阶段：

<img src="https://raw.githubusercontent.com/KKKLxxx/img-host/master/image-20231125222152134.png" alt="image-20231125222152134" style="zoom: 50%;" />

- **第一阶段**：slave请求同步数据，这时slave会发送自己的replid和offset。master收到请求后，判断replid是否一致，如果不一致，说明是首次同步，需要进行全量同步，会向slave发送master的replid和offset
- **第二阶段**：master执行bgsave生成快照并发送给slave，slave清空数据并加载快照。同时master会将这期间所有的写命令记录到repl_backlog中
- **第三阶段**：master将repl_backlog发送给slave，slave接收到后继续同步

## 二、增量同步

当slave重启后，可以只进行增量同步

增量同步过程可以分为两个阶段：

<img src="https://raw.githubusercontent.com/KKKLxxx/img-host/master/image-20231125223717655.png" alt="image-20231125223717655" style="zoom:50%;" />

- **第一阶段**：与全量同步相同，但是返回的结果不同
- **第二阶段**：master通过offset从repl_backlog中获取slave需要的数据，并发送给slave

增量同步存在的问题在于，repl_backlog有大小限制，写满后会覆盖最早的数据。如果slave断开时间过久，可能导致数据丢失，此时需要重新执行全量同步

## 三、总结

想要提高主从同步的性能，就是要尽量避免全量同步，或者提高同步的性能

为了避免全量同步，可以提高repl_backlog的大小限制，并在slave宕机后及时重启

为了提高同步的性能，有以下两种方法：

- 开启master中的`repl-diskless-sync yes`配置（默认开启），这样RDB文件不会写入磁盘，而是直接写入与slave的socket连接中
- 建立“主-从-从”结构。当slave过多时，如果所有slave都需要从master同步数据，那么会造成master的压力过大。可以让一部分从节点以另一部分从节点为master，这样master用于同步数据的压力就会小很多

## 四、问题

### 1. 全量同步时，为什么不能在RDB全量同步后直接用AOF增量同步？而要单独搞一个repl_backlog？

主要是因为AOF仅用于恢复数据，而非同步数据。AOF没有offset的概念，并且会被重写，无法保证主从同步

所以需要单独设计一个repl_backlog

### 2. 主从架构中，从节点的过期key如何处理？

主节点通过过期删除策略删除过期key后，会模拟一条DEL命令发送给从节点，之后从节点执行该命令

### 3. 主从切换的数据丢失问题

数据丢失指的是更换主节点时，主节点的数据还没来得及同步给从节点就发生宕机，而从节点作为新的主节点后，会导致丢失一部分旧主节点数据的问题

除非人工可预期地更换主节点时，可以通过暂停接收客户端请求来使数据不丢失。当主节点发生非预期的故障时，一定会发生数据丢失，我们只能尽可能地减少数据丢失

有两种可能的故障：

- 主节点真正宕机导致来不及同步数据
- 哨兵模式下，主节点网络故障，选举产生新的主节点后，原主节点恢复但降级为从节点，导致数据无法同步

解决方法仍然是让主节点暂停接收客户端的请求，但可以通过设置一些参数使这个过程自动化

比如主节点要与超过半数的从节点保持连接，连接延迟不能超过一定时间等。若不满足，则自动暂停接收请求并更换主节点

