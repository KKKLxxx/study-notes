# Redis过期key的实现

## 一、存储结构

![image-20231124211026519](https://raw.githubusercontent.com/KKKLxxx/img-host/master/image-20231124211026519.png)

redisDb结构中，除了使用一个dict用于存储所有的键值对，还有一个dict类型的`expires`用于存储所有过期键。`expires`中的value记录的不再是key对应的值，而是key的过期时间

## 二、过期key的删除时机

因为当key很多时，如果持续不断地轮询`expires`会对redis造成很大的压力，所以实时删除是无法接受的

所以redis采取的方法是惰性删除和周期删除

### 1、惰性删除

惰性删除指的是在访问某个key时，先检验其是否过期，如果过期了，则执行删除操作

### 2、周期删除

只有惰性删除的缺陷在于，如果一个过期key已经过期了，但是一致没有被访问，那么这个key就会一直存在。这种情况积累多了，会对内存造成很大的浪费，并且无法正确触发一些过期事件

所以在惰性删除外，还会对`expires`进行周期性的检测，将已过期的key删除。然而每个周期只会对一部分key进行检测，在多个周期后可以完成对所有key的检测

周期删除还分为SLOW和FAST两种模式：

- **SLOW**：低频执行，但每次执行相对较长时间，每次会对更多key进行检测
- **FAST**：高品质行，但每次执行时间较短，每次检测的key更少

