# Redis缓存更新策略

**要根据数据一致性要求和维护成本综合考虑**

## 一、过期更新

对key设置过期时间，等待key过期。这种方案数据一致性要求低，但实现简单

## 二、主动更新

### 1. 先更新数据库，再删缓存（推荐）

**失效场景**：A查询，B更新。A缓存未命中，准备将数据库中的数据放入缓存。此时B更新了数据库并删除缓存，A将旧数据放入了缓存导致以后的数据仍为旧数据

### 2. 先删缓存，再更新数据库

**失效场景**：A查询，B更新。B先把缓存删除，A缓存未命中，将旧数据重新添加到缓存，导致以后的数据仍为旧数据

**因为对缓存的操作速度更快，可以认为方案1的失效场景发生的概率更小**（也就是认为A读完数据库后更新缓存较快，不会等到B删除缓存后才更新缓存）

### 3. 延时双删策略（推荐）

#### 3.1 作用

延时双删策略就是为了**保证方案1中，读请求结束，写请求可以删除读请求造成的缓存脏数据**

#### 3.2 执行过程

1、删除缓存（第一次删除）

2、更新mysql

3、延时xxx秒（根据业务决定，要确保读请求结束）

4、删除缓存（第二次删除）

#### 3.3 延时的实现方式

##### 3.3.1 消息队列

可以借助消息队列实现延迟消费

##### 3.3.2 订阅binlog

消息队列的方式对代码有一定的入侵性，也可以通过订阅binlog，根据binlog获取redis中的key，然后再删除。由于需要延迟消费，所以还是需要通过消息队列实现