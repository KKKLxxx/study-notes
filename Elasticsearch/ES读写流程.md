# ES读写流程

## 一、写流程

<img src="https://raw.githubusercontent.com/KKKLxxx/img-host/master/image-20220215153121689.png" alt="image-20220215153121689" style="zoom: 80%;" />

1、集群中的协调节点接收到数据，根据数据id进行路由计算（协调节点通过轮询等方式进行负载均衡选取）

2、根据路由结果，假设应该存储在P0分片上，那么就会发送给node 3

3、P0分片写好数据后，将数据写入node 1与node 2的两个副本中

4、副本数据全都写入成功后，node 3向协调节点返回结果（因为P0在node 3上），协调节点再向客户端返回结果

（可以根据实际情况调整向客户端返回结果的时间，比如在主分片写入成功后立即返回，之后再向副本写入）

## 二、读流程

<img src="https://raw.githubusercontent.com/KKKLxxx/img-host/master/image-20220215154939795.png" alt="image-20220215154939795" style="zoom:80%;" />

1、集群中的协调节点收到请求，根据数据id进行路由计算

2、协调节点找出该数据对应的分片和所有副本

3、以轮询等方式，负载均衡地转发请求到对应的分片或副本

4、被请求的节点返回数据给协调节点，协调节点向客户端返回结果