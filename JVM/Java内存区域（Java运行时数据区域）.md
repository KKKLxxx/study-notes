# Java内存区域（Java运行时数据区域）

**首先要区分两个概念**

1、Java内存区域（Java运行时数据区域），描述的是堆、栈等区域的划分

2、Java内存模型（JMM），用来屏蔽各种硬件和操作系统的内存访问差异，以实现Java程序在各种平台都能达到一致的内存访问效果

## 一、概念

Java虚拟机在执行Java程序的过程中会把它所管理的内存划分为若干个不同的数据区域。这些区域有各自的用途，以及创建和销毁的时间，有的区域随着虚拟机进程的启动而一直存在，有些区域则是依赖用户线程的启动和结束而建立和销毁。根据《Java虚拟机规范》的规定，Java虚拟机所管理的内存将会包括以下几个运行时数据区域，如图所示

<img src="https://raw.githubusercontent.com/KKKLxxx/img-host/master/20210903220657932.png" style="zoom:50%;" />

## 二、内存区域具体划分

### 1、程序计数器

**作用**：当前线程所执行的字节码的行号指示器，**指向当前线程所要执行的下一条指令的地址**

为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间计数器互不影响，独立存储

### 2、虚拟机栈

**作用**：**每个方法被执行的时候，Java虚拟机都会同步创建一个栈帧（Stack Frame）用于存储局部变量表、操作数栈、动态连接、方法出口等信息**。每一个方法被调用直至执行完毕的过程，就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程

**扩展**：**局部变量表**存放了**编译期可知**的各种Java虚拟机**基本数据类型**、**对象引用**（不等同于对象本身）和**returnAddress类型**（指向了一条字节码指令的地址）

### 3、本地方法栈

**作用**：与虚拟机栈所发挥的作用是非常相似的，其区别只是虚拟机栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则是**为虚拟机使用到的本地（native）方法服务**

**本地方法**：指的是在本地已经用`c/c++`等语言编写好的方法，然后可以在Java程序中进行调用。如`System.currentTimeMillis()`方法，查看源码可得

```java
public static native long currentTimeMillis();
```

`native`表明这里调用的实际上是一个本地方法

### 4、堆

**作用**：**存放对象、数组、静态变量、字符串常量池**

**堆是垃圾收集器管理的内存区域**

**逃逸分析**：如果某些方法中的对象引用没有被返回或者未被外面使用（也就是未逃逸出去），那么对象可以直接在栈上分配内存

### 5、方法区

**作用**：**存储类的信息（字段、方法、接口）、常量、运行时常量池**

**运行时常量池**：用于存放**编译期生成的各种字面量与符号引用**，在类加载机制的“解析”过程将符号引用替换为直接引用

**方法区的收集主要回收两部分内容**：常量池中的废弃的常量和不再使用的类型

#### JDK8将永久代替换为元空间的原因

方法区是一种规范，它的具体实现是永久代/元空间

1、**内存限制**：永久代的大小受到JVM的限制，当加载的类很多时，容易出现OOM；元空间直接使用机器的物理内存，不受JVM大小限制

2、**发展原因**：JDK8将JRockit虚拟机合并到HotSpot虚拟机时，由于JRockit本身就没有永久代的设计，所以最终统一舍弃了永久代

